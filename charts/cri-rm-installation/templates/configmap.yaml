apiVersion: v1
kind: ConfigMap
metadata:
  name: cri-rm-installation-script
  namespace: kube-system
  annotations:
    resources.gardener.cloud/ignore: "true"
data:
  install-cri-rm.sh: |-
    #!/bin/sh
    cp -r /cri-rm-installation/opt/ /var/host/
    cp -r /cri-rm-installation/etc/ /var/host/
    cp /var/host/etc/cri-resmgr/fallback.cfg.sample /var/host/etc/cri-resmgr/fallback.cfg
    chroot /var/host bash -c "systemctl enable cri-resource-manager"
    chroot /var/host bash -c "systemctl restart cri-resource-manager"
    sed -i  '/containerd/d' /var/host/etc/systemd/system/kubelet.service
    if ! grep -q container-runtime-endpoint  "/var/host/etc/systemd/system/kubelet.service"; then
      sed '/KUBELET_EXTRA_ARGS/ s!$! --container-runtime-endpoint=/var/run/cri-resmgr/cri-resmgr.sock!' -i /var/host/etc/systemd/system/kubelet.service
    fi
    # DO NOT KILL KUBELET YET ! :)
    chroot /var/host bash -c "systemctl daemon-reload"
    chroot /var/host bash -c "systemctl restart kubelet"
    sleep 7600
