# CRI-Resource-Manager extension for Gardener*

**Note:** This is work in progress, not meant to run in production!

### Introduction

Those charts will deploy [CRI-resource-manager](https://github.com/intel/cri-resource-manager) as proxy between kubectl and containerd in "shoot" clusters deployed by Gardener*.

### Description

There are three charts:

- charts/**gardener-extension-cri-resmgr** - used to deploy extension (by deploying "extension" image) in **Seed** cluster - it is not deployed manually but using `ControllerRegistration` and `ControllerDeployment` manifest in `examples/ctrldeploy-ctrlreg.yaml` which are generated by script `hacks/generate-controller-registration.sh`,
- charts/**cri-resmgr-installation** - internal chart that is included inside "installation" image and used to install `cri-resource-manager` binary inside worker nodes in **Shoot** clusters - it is not meant to be run manually but rather deployed by **gardener-extension-cri-resmgr** chart
- charts/**cri-resmgr-installation** - internal chart that is included inside "installation" image and used to remove `cri-resource-manager` binary inside worker nodes in **Shoot** clusters - it is not meant to be run manually but rather deployed by **gardener-extension-cri-resmgr** chart


## I. Deploying to Gardener.

### Prerequisites

- *kubectl* 1.20+
- working dir for `mkdir ~/work`
- *gardener-extension-cri-resmgr* is cloned to ~/work path like this:
    ```
    git clone https://github.com/intel/gardener-extension-cri-resmgr ~/work/gardener-extension-cri-resmgr
    ```

### 1. Build and publish docker images.

```
make docker-images
make publish-docker-images
```

**Note** By default the "private" v2.isvimgreg.com registry is set and used. If you want to use other registry, please modify this files to point to other registry: 

For example: if you want use **registry-example.com** as registry:

* ``charts/cri-resmgr-installation/templates/daemonset.yaml`` and its **spec.template.spec.containers.image** value to "registry-example.com/gardener-extension-cri-resmgr" 
* ``charts/cri-resmgr-removal/templates/daemonset.yaml`` and its **spec.template.spec.containers.image** value to "registry-example.com/gardener-extension-cri-resmgr" 
* ``charts/gardener-extension-cri-resmgr/values.yaml`` and its **image.repository** value to "registry-example.com/gardener-extension-cri-resmgr"

and specifiy REGISTRY env varible when building like this:

```
make REGISTRY=registry-example.com/ docker-images
make REGISTRY=registry-example.com/ publish-docker-images
```
Image vector support will be added soon.

### 2. Install extension by creating ControllerRegistration and ControllerDeployment in garden cluster.

```
kubectl apply -f examples/ctrldeploy-ctrlreg.yaml
```

### 3. Create shoot cluster with **cri-resmgr-extension**:
```
kubectl apply -f examples/shoot.yaml
```

## II. Getting started locally (with kind-based local gardener setup).

### Prepare local kind-based garden cluster

#### 1. Clone the gardener
```
mkdir -p ~/work/
git clone https://github.com/gardener/gardener ~/work/gardener
cd ~/work/gardener
git checkout v1.49.3
```

#### 2. Prepare kind cluster 

This is based on https://github.com/gardener/gardener/blob/master/docs/deployment/getting_started_locally.md


```
cd ~/work/gardener
make kind-up

kubectl cluster-info --context kind-gardener-local --kubeconfig /root/work/gardener/example/gardener-local/kind/kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/work/gardener/example/provider-local/base/kubeconfig
# WARNING!: this overwrites your local kubeconfig
cp /root/work/gardener/example/gardener-local/kind/kubeconfig /root/.kube/config
```

Check everything is fine:
```
kubectl get nodes
```

####  3. Deploy local gardener

```
make gardener-up
```

Check that three gardener charts are installed:
```
helm list -n garden
```

### Deploy cri-resmgr extension

#### 4. (Optional) Regenerate ctrldeploy-ctrlreg.yaml file:

```
cd ~/work/gardener-extension-cri-resmgr
./hacks/generate-controller-registration.sh
```

#### 5. Deploy cri-resmgr-extension as Gardener extension using ControllerRegistration/ControllerDeployment

```
cd ~/work/gardener-extension-cri-resmgr
kubectl apply -f ./examples/ctrldeploy-ctrlreg.yaml
```

By default generated "ControllerRegistration" is not enabled globally, so you need to include this extension in shoot defintion. Check [this shoot.yaml](examples/shoot.yaml) as example.

In our shoot example, the extensions is also disabled by defualt and need to be enabled after shoot is created with following command:

```
kubectl patch shoot local -n garden-local -p '{"spec":{"extensions": [ {"type": "cri-resmgr-extension", "disabled": false} ] } }'
```

Checkout installed objects:
```
kubectl get controllerregistrations.core.gardener.cloud cri-resmgr-extension
kubectl get controllerdeployments.core.gardener.cloud cri-resmgr-extension
```
There should be 'cri-resmgr-extension   Extension/cri-resmgr-extension' resources visible alongside cri-resmgr-extension deployment.

but installation should not be yet available - there is not yet shoot cluster deployed yet.

```
kubectl get controllerinstallation.core.gardener.cloud 
```

#### 5. Deploy shoot "local" cluster.

Build an image with extension and upload to local kind cluster
```
make docker-images
# by default v2.isvimgreg.com registry is used (check 'Build and publish docker images' section for more info)
```

Deploy those images to inside kind cluster (not need if public registry is used):
```
kind load docker-image v2.isvimgreg.com/gardener-extension-cri-resmgr:latest --name gardener-local
kind load docker-image v2.isvimgreg.com/gardener-extension-cri-resmgr-installation:latest --name gardener-local
```

Create shoot:

```
kubectl apply -f examples/shoot.yaml
```

Check that shoot cluster is ready:

```
kubectl get shoots.core.gardener.cloud -n garden-local --watch -o wide
```

#### 6. Verify that ManagedResources are properly installed in shoot 'garden' (seed class) and  'shoot--local--local' namespace

```
kubectl get managedresource -n garden | grep cri-resmgr-extension
kubectl get managedresource -n shoot--local--local | grep cri-resmgr-installation
```

#### 7. Check shoot cluster node is ready

First get credentials to access shoot cluster:

``` 
kubectl -n garden-local get secret local.kubeconfig -o jsonpath={.data.kubeconfig} | base64 -d > /tmp/kubeconfig-shoot-local.yaml
```

and check status of the node:
```
kubectl --kubeconfig=/tmp/kubeconfig-shoot-local.yaml get nodes
```

#### 8. Check CRI-resource-manager is installed properly as proxy

```
kubectl exec -n shoot--local--local `kubectl get pod -n shoot--local--local --no-headers G machine-shoot | awk '{print $1}'` -- systemctl status cri-resource-manager kubelet -n 0
```
